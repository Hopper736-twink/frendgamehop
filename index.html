<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PartyGame FINAL</title>
<style>
*{box-sizing:border-box}
body{margin:0;height:100vh;font-family:system-ui,Arial;background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);color:#fff;display:flex;justify-content:center;align-items:center;}
#app{width:100%;max-width:420px;padding:20px;}
.card{background:rgba(255,255,255,.12);backdrop-filter:blur(14px);border-radius:22px;padding:20px;box-shadow:0 20px 40px rgba(0,0,0,.45);animation:fade .3s ease;}
h1,h2{text-align:center;margin-top:0}
button{width:100%;padding:14px;margin-top:12px;border:none;border-radius:16px;font-size:16px;background:#ff4ecd;color:white;cursor:pointer;transition:.2s;}
button:hover{transform:scale(1.04)}
input{width:100%;padding:14px;margin-top:12px;border-radius:16px;border:none;font-size:16px;}
.menu button{background:#6c63ff}
.small{opacity:.8;font-size:14px;text-align:center}
@keyframes fade{from{opacity:0;transform:translateY(10px)}to{opacity:1}}
</style>
</head>
<body>
<div id="app"></div>
<script>
const app=document.getElementById("app");

// ====== –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ======
let players=[],turn=0,fatigue={};
let truths=[],dares=[],tasksLoaded=false;
let spyWords=[],spyPlayers=[],spyIndex=0,spyTopic="",timerDuration=120,timerInterval=null;
let mafiaPlayers=[],mafiaRoles=[];

// ====== –ó–∞–≥—Ä—É–∑–∫–∞ JSON ======
async function loadTasks(){
  try{
    const res = await fetch("tasks.json");
    const data = await res.json();
    truths = data.truth;
    dares = data.dare;
    tasksLoaded = true;
  } catch(err){
    alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞–Ω–∏–π: "+err);
  }
}
async function loadSpyWords(){
  try{
    const res = await fetch("spy_words.json");
    const data = await res.json();
    spyWords = data;
  } catch(err){
    alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–º —à–ø–∏–æ–Ω–∞: "+err);
  }
}
loadTasks();
loadSpyWords();

// ====== –ú–µ–Ω—é ======
function mainMenu(){
  app.innerHTML=`
    <div class="card menu">
      <h1>üéâ PartyGame</h1>
      <button onclick="truthMenu()">üé≠ –ü—Ä–∞–≤–¥–∞ –∏–ª–∏ –¥–µ–π—Å—Ç–≤–∏–µ</button>
      <button onclick="spyMenu()">üïµÔ∏è –®–ø–∏–æ–Ω</button>
      <button onclick="mafiaMenu()">ü©∏ –ú–∞—Ñ–∏—è</button>
      <p class="small">–ü–µ—Ä–µ–¥–∞–≤–∞–π—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –ø–æ –∫—Ä—É–≥—É</p>
    </div>
  `;
}

// ====== –ü—Ä–∞–≤–¥–∞ –∏–ª–∏ –¥–µ–π—Å—Ç–≤–∏–µ ======
function truthMenu(){
  players=[];fatigue={};turn=0;
  app.innerHTML=`
    <div class="card">
      <h2>–ü—Ä–∞–≤–¥–∞ –∏–ª–∏ –¥–µ–π—Å—Ç–≤–∏–µ</h2>
      <input id="name" placeholder="–ò–º—è –∏–≥—Ä–æ–∫–∞">
      <button onclick="addPlayer()">–î–æ–±–∞–≤–∏—Ç—å</button>
      <div id="list" class="small"></div>
      <button onclick="startTruth()">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
      <button onclick="mainMenu()">‚¨Ö –ù–∞–∑–∞–¥</button>
    </div>
  `;
}
function addPlayer(){
  const n=document.getElementById("name").value.trim();if(!n)return;
  players.push(n);fatigue[n]=0;
  document.getElementById("list").innerText=players.join(", ");
  document.getElementById("name").value="";
}
function startTruth(){
  if(!tasksLoaded) return alert("–ó–∞–¥–∞–Ω–∏—è –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å, –ø–æ–¥–æ–∂–¥–∏—Ç–µ –ø–∞—Ä—É —Å–µ–∫—É–Ω–¥");
  if(players.length<2) return alert("–ú–∏–Ω–∏–º—É–º 2 –∏–≥—Ä–æ–∫–∞");
  nextTruth();
}
function nextTruth(extra=false){
  if(truths.length===0||dares.length===0) return alert("–ù–µ—Ç –∑–∞–¥–∞–Ω–∏–π!");
  const name=players[turn];
  const isTruth=Math.random()<0.5;
  const task=isTruth ? truths[Math.floor(Math.random()*truths.length)] 
                      : dares[Math.floor(Math.random()*dares.length)];
  app.innerHTML=`
    <div class="card">
      <h2>${name}</h2>
      <p>${isTruth?"ü§î –ü—Ä–∞–≤–¥–∞":"üî• –î–µ–π—Å—Ç–≤–∏–µ"}</p>
      <p>${task}</p>
      <button onclick="done()">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</button>
      <button onclick="skip()">–û—Ç–∫–∞–∑</button>
    </div>
  `;
  if(!extra) turn=(turn+1)%players.length;
}
function done(){nextTruth();}
function skip(){
  const name=players[(turn-1+players.length)%players.length];
  fatigue[name]++;
  if(fatigue[name]>=2){fatigue[name]=0;nextTruth(true);}else nextTruth();
}

// ====== –®–ø–∏–æ–Ω ======
function spyMenu(){
  spyPlayers=[];spyIndex=0;spyTopic="";timerDuration=120;
  app.innerHTML=`
    <div class="card">
      <h2>üïµÔ∏è –®–ø–∏–æ–Ω</h2>
      <input id="name" placeholder="–ò–º—è –∏–≥—Ä–æ–∫–∞">
      <button onclick="addSpyPlayer()">–î–æ–±–∞–≤–∏—Ç—å –∏–≥—Ä–æ–∫–∞</button>
      <div id="list" class="small"></div>
      <input id="time" type="number" placeholder="–í—Ä–µ–º—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö" min="30" max="600">
      <button onclick="startSpy()">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
      <button onclick="mainMenu()">‚¨Ö –ù–∞–∑–∞–¥</button>
    </div>
  `;
}
function addSpyPlayer(){
  const n=document.getElementById("name").value.trim();if(!n)return;
  spyPlayers.push(n);
  document.getElementById("list").innerText=spyPlayers.join(", ");
  document.getElementById("name").value="";
}
function startSpy(){
  if(spyPlayers.length<2) return alert("–ú–∏–Ω–∏–º—É–º 2 –∏–≥—Ä–æ–∫–∞");
  timerDuration=parseInt(document.getElementById("time").value)||120;
  // –≤—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é —Ç–µ–º—É
  const t=spyWords[Math.floor(Math.random()*spyWords.length)];
  spyTopic=t.word;
  spyIndex=0;
  spyNext();
}
function spyNext(){
  if(spyIndex>=spyPlayers.length){spyRound();return;}
  const name=spyPlayers[spyIndex];
  app.innerHTML=`
    <div class="card">
      <h2>${name}</h2>
      <p id="role">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ä–æ–ª—å</p>
      <button onclick="toggleSpyRole()">–ü–æ–∫–∞–∑–∞—Ç—å/–°–∫—Ä—ã—Ç—å</button>
    </div>
  `;
}
function toggleSpyRole(){
  const roleEl=document.getElementById("role");
  if(roleEl.innerText==="–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ä–æ–ª—å"){
    roleEl.innerText=(spyIndex===0?"–¢—ã —à–ø–∏–æ–Ω":"–°–ª–æ–≤–æ: "+spyTopic);
  } else {
    spyIndex++;
    spyNext();
  }
}
function spyRound(){
  let timeLeft=timerDuration;
  app.innerHTML=`
    <div class="card">
      <h2>–í–æ–ø—Ä–æ—Å—ã –ø–æ —Ç–µ–º–µ: ${spyTopic}</h2>
      <p id="timer">${timeLeft}</p>
      <p>–í—Å–µ –∏–≥—Ä–æ–∫–∏ –≤–∏–¥—è—Ç –≤–æ–ø—Ä–æ—Å—ã, —à–ø–∏–æ–Ω —É–≥–∞–¥—ã–≤–∞–µ—Ç —Å–ª–æ–≤–æ.</p>
      <button onclick="spyWin()">–®–ø–∏–æ–Ω —É–≥–∞–¥–∞–ª</button>
      <button onclick="spyLose()">–®–ø–∏–æ–Ω –ø—Ä–æ–∏–≥—Ä–∞–ª</button>
    </div>
  `;
  timerInterval=setInterval(()=>{
    timeLeft--;
    document.getElementById("timer").innerText=timeLeft;
    if(timeLeft<=0){clearInterval(timerInterval);spyLose();}
  },1000);
}
function spyWin(){clearInterval(timerInterval);alert("–®–ø–∏–æ–Ω —É–≥–∞–¥–∞–ª —Å–ª–æ–≤–æ!");mainMenu();}
function spyLose(){clearInterval(timerInterval);alert("–®–ø–∏–æ–Ω –ø—Ä–æ–∏–≥—Ä–∞–ª!");mainMenu();}

// ====== –ú–∞—Ñ–∏—è ======
function mafiaMenu(){
  mafiaPlayers=[];mafiaRoles=[];turn=0;
  app.innerHTML=`
    <div class="card">
      <h2>ü©∏ –ú–∞—Ñ–∏—è</h2>
      <input id="name" placeholder="–ò–º—è –∏–≥—Ä–æ–∫–∞">
      <button onclick="addMafiaPlayer()">–î–æ–±–∞–≤–∏—Ç—å –∏–≥—Ä–æ–∫–∞</button>
      <div id="list" class="small"></div>
      <button onclick="startMafia()">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
      <button onclick="mainMenu()">‚¨Ö –ù–∞–∑–∞–¥</button>
    </div>
  `;
}
function addMafiaPlayer(){
  const n=document.getElementById("name").value.trim();if(!n)return;
  mafiaPlayers.push(n);
  document.getElementById("list").innerText=mafiaPlayers.join(", ");
  document.getElementById("name").value="";
}
function startMafia(){
  if(mafiaPlayers.length<3) return alert("–ú–∏–Ω–∏–º—É–º 3 –∏–≥—Ä–æ–∫–∞");
  mafiaRoles = ["–ú–∞—Ñ–∏—è","–î–æ–∫—Ç–æ—Ä","–®–µ—Ä–∏—Ñ"];
  while(mafiaRoles.length<mafiaPlayers.length) mafiaRoles.push("–ú–∏—Ä–Ω—ã–π");
  mafiaRoles.sort(()=>Math.random()-0.5);
  showMafiaRoles(0);
}
function showMafiaRoles(i){
  if(i>=mafiaPlayers.length){alert("–í—Å–µ —Ä–æ–ª–∏ –ø–æ–∫–∞–∑–∞–Ω—ã!");mainMenu();return;}
  const name=mafiaPlayers[i];
  app.innerHTML=`
    <div class="card">
      <h2>${name}</h2>
      <p id="role">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ä–æ–ª—å</p>
      <button onclick="toggleMafiaRole(${i})">–ü–æ–∫–∞–∑–∞—Ç—å/–°–∫—Ä—ã—Ç—å</button>
    </div>
  `;
}
function toggleMafiaRole(i){
  const roleEl=document.getElementById("role");
  if(roleEl.innerText==="–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ä–æ–ª—å"){
    roleEl.innerText=mafiaRoles[i];
  } else {
    showMafiaRoles(i+1);
  }
}

mainMenu();
</script>
</body>
</html>
